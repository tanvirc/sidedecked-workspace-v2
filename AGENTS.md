# AGENTS.md - SideDecked BMAD Operating Guide

This document is the execution contract for Codex agents in this workspace.

Scope and precedence:
- This root file applies to the whole workspace.
- Repo-local `AGENTS.md` files in `backend/`, `customer-backend/`, `storefront/`, and `vendorpanel/` override root rules for their subtree.
- If rules conflict, follow the most specific file closest to the edited code.

## Core Architecture (Non-Negotiable)

SideDecked is a split-domain system:
- `backend/` uses `mercur-db` for commerce (orders, payments, vendors).
- `customer-backend/` uses `sidedecked-db` for catalog, decks, community, pricing.
- `storefront/` and `vendorpanel/` are UIs and must call APIs only.

Hard boundaries:
- Never connect one backend directly to the other backend database.
- Cross-domain behavior must go through HTTP APIs/events.
- Do not move features to another bounded context without explicit approval.

## BMAD-First Planning Path (Required)

Primary planning authority:
- BMAD workflow artifacts and gates are the source of truth for planning and execution readiness.
- Use workspace BMAD assets generated by install:
  - `_bmad/` (method assets and configs)
  - `_bmad-output/planning-artifacts/`
  - `_bmad-output/implementation-artifacts/`
  - `.claude/commands/bmad-*.md` command surface

Legacy trackers:
- `module-status.json` and `scripts/*spec*.js` remain required for status reporting and compatibility.
- They do not replace BMAD phase gates or BMAD planning artifacts.

Mandatory full planning sequence:
1. Analysis: product brief and research.
2. Planning: PRD creation/validation.
3. Solutioning: architecture and implementation-readiness check.
4. Storying: epics/stories and sprint planning.
5. Delivery: story implementation and review.
6. QA and retrospection: quality automation/review and course correction.

Recommended command map:
- `/bmad-bmm-create-product-brief`
- `/bmad-bmm-domain-research`, `/bmad-bmm-market-research`, `/bmad-bmm-technical-research`
- `/bmad-bmm-create-prd`, `/bmad-bmm-edit-prd`, `/bmad-bmm-validate-prd`
- `/bmad-bmm-create-architecture`, `/bmad-bmm-check-implementation-readiness`
- `/bmad-bmm-create-epics-and-stories`, `/bmad-bmm-create-story`, `/bmad-bmm-sprint-planning`
- `/bmad-bmm-dev-story`, `/bmad-bmm-code-review`, `/bmad-bmm-qa-automate`
- `/bmad-bmm-correct-course`, `/bmad-bmm-retrospective`

## Agent Model

### BMAD Core Agents (Phase Owners)

- `analyst`
  - Owns discovery, constraints, and brief quality.
- `pm`
  - Owns PRD scope, outcomes, and acceptance shape.
- `architect`
  - Owns architecture decisions, interfaces, and readiness.
- `sm`
  - Owns epic/story decomposition and sprint sequencing.
- `dev`
  - Owns implementation fidelity to approved story scope.
- `qa`
  - Owns test strategy, risk discovery, and quality gates.
- `po`
  - Owns readiness and quality gate sign-off before implementation handoff.

### SideDecked Specialist Agents (Domain Overlays)

- `commerce-specialist` (repo: `backend/`)
  - Authority: checkout, orders, payments, vendor commerce flows on `mercur-db`.
  - Forbidden: direct `sidedecked-db` access.
- `customer-data-specialist` (repo: `customer-backend/`)
  - Authority: catalog, deck, community, pricing flows on `sidedecked-db`.
  - Forbidden: direct `mercur-db` access.
- `storefront-specialist` (repo: `storefront/`)
  - Authority: customer journey UI and API-consumption patterns.
  - Forbidden: direct DB access and backend ownership changes.
- `vendorpanel-specialist` (repo: `vendorpanel/`)
  - Authority: vendor/admin workflows and operational UI.
  - Forbidden: direct DB access and backend ownership changes.

Collaboration rule:
- Every BMAD phase is led by its BMAD core owner.
- Before phase completion, required specialist overlays must review bounded-context correctness for touched domains.

## Required Workflow

1. Announce next action before tool calls.
2. For multi-step work, maintain a concise execution checklist with `update_plan`.
3. Search with `rg`, read in focused chunks, implement surgically.
4. Validate with nearest tests/checks first, then broader repo gates.
5. Record BMAD outputs in `_bmad-output/*` and summarize residual risks.
6. Keep `module-status.json` synchronized with actual specification progress.

## Context Loading Protocol

Always read first for architecture-sensitive work:
- `docs/architecture/01-system-overview.md`
- `docs/architecture/02-architectural-principles.md`
- `docs/standards/code-standards.md`
- `docs/standards/testing-standards.md`

Then load task-specific architecture requirements:

| Task Type | Required Documentation |
|-----------|------------------------|
| New feature | `docs/architecture/03-domain-models.md`, `docs/architecture/04-architectural-patterns.md`, relevant spec in `docs/specifications/` |
| Bug fix | `docs/architecture/04-architectural-patterns.md`, relevant repo architecture doc, relevant standards doc in `docs/standards/` |
| API change | `docs/architecture/06-integration-architecture.md`, `docs/API-REFERENCE.md`, relevant repo architecture doc |
| Database/schema change | `docs/architecture/05-data-architecture.md`, `docs/architecture/03-domain-models.md`, affected repo migration patterns |
| Authentication/security | `docs/architecture/07-authentication-architecture.md`, `docs/architecture/06-integration-architecture.md`, `SECURITY.md` |
| UI flow/component change | `docs/architecture/01-system-overview.md`, relevant UI architecture doc (`storefront/docs/ARCHITECTURE.md` or `vendorpanel/docs/ARCHITECTURE.md`) |
| Performance/caching work | `docs/architecture/01-system-overview.md`, `docs/architecture/05-data-architecture.md`, `docs/architecture/06-integration-architecture.md` |

Pre-implementation gate:
- Identify bounded context and target repo.
- Confirm required docs for task type were reviewed.
- State affected APIs, data boundaries, and validation plan.

## Mandatory Engineering Rules

- No placeholders, stubbed production logic, or fake success paths.
- TDD where a harness exists; keep changed-module coverage at `>=80%` when measurable.
- TypeScript strict mode, zero lint/type errors, and passing build/tests before completion.
- Follow existing service/controller/repository/event patterns.
- Keep logging and error handling actionable.

Medusa/MercurJS forbidden patterns:
- `MedusaRequest` (use `MedusaStoreRequest`).
- Bare module path strings (use `{ resolve: "..." }` object format).
- `authIdentity: null` (use `undefined`).
- Lambda defaults where literal defaults are expected.

## Work Selection and Acceptance Gate

Selection priority:
1. Active BMAD story approved in planning artifacts.
2. If no active BMAD story is selected, continue `module-status.json.current_specification` unless completed.
3. Otherwise use lowest-numbered `in_progress`, then lowest-numbered `not_started`.

Acceptance rule:
- Do not advance story/spec until all criteria for current unit are implemented.
- Status mapping in spec files:
  - `IMPLEMENTED` or `COMPLETED` => complete
  - `IN PROGRESS` or `PARTIAL` => in progress
  - `NOT BUILT`, `NOT STARTED`, `TODO` => not started

Helper commands:
- `node scripts/next-spec.js`
- `node scripts/check-acceptance-criteria.js --id <spec-id>`
- `node scripts/check-acceptance-criteria.js --id <spec-id> --next-story`
- `node scripts/mark-spec.js --id <spec-id> --status in_progress`
- `node scripts/mark-spec.js --id <spec-id> --status completed`

## Repo Routing Map

Choose the right repo before implementation:
- Commerce, sellers, checkout, payouts, orders => `backend/`
- Catalog, decks, community, pricing intelligence => `customer-backend/`
- Customer UI/UX flows => `storefront/`
- Vendor/admin UI workflows => `vendorpanel/`

## Validation and Delivery

Before completion:
- Run closest relevant checks in the edited repo.
- If available, run `lint`, `typecheck`, `build`, and tests.
- Update docs/changelog when behavior, APIs, or setup changed.

Commits:
- Conventional format `type(scope): description`.
- No AI/assistant/automation attribution text in commit messages.
- Keep commits scoped to the repo actually changed.
