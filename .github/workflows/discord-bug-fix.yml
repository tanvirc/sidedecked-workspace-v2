name: Discord Bug Fix

on:
  issues:
    types: [opened]

jobs:
  fix-bug:
    if: contains(github.event.issue.labels.*.name, 'discord-bug')
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write

    steps:
      # --- Checkout all repos ---

      - name: Checkout workspace-v2
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Checkout storefront
        uses: actions/checkout@v4
        with:
          repository: tanvirc/sidedecked-storefront
          token: ${{ secrets.CROSS_REPO_TOKEN }}
          path: repos/storefront

      - name: Checkout vendorpanel
        uses: actions/checkout@v4
        with:
          repository: tanvirc/sidedecked-vendorpanel
          token: ${{ secrets.CROSS_REPO_TOKEN }}
          path: repos/vendorpanel

      - name: Checkout backend
        uses: actions/checkout@v4
        with:
          repository: tanvirc/sidedecked-backend
          token: ${{ secrets.CROSS_REPO_TOKEN }}
          path: repos/backend

      - name: Checkout customer-backend
        uses: actions/checkout@v4
        with:
          repository: tanvirc/sidedecked-customer-backend
          token: ${{ secrets.CROSS_REPO_TOKEN }}
          path: repos/customer-backend

      # --- Safety gate ---

      - name: Verify issue author
        env:
          EXPECTED_BOT: ${{ vars.DISCORD_BOT_GITHUB_USER || 'tanvirc' }}
        run: |
          AUTHOR="${{ github.event.issue.user.login }}"
          if [ "$AUTHOR" != "$EXPECTED_BOT" ]; then
            echo "::error::Issue #${{ github.event.issue.number }} created by '$AUTHOR', expected '$EXPECTED_BOT'. Skipping."
            exit 1
          fi

      # --- Configure git in each repo ---

      - name: Configure git identity
        run: |
          for SERVICE in storefront vendorpanel backend customer-backend; do
            cd "repos/${SERVICE}"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            cd "$GITHUB_WORKSPACE"
          done

      # --- Download screenshots ---

      - name: Download bug report images
        id: images
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          mkdir -p screenshots
          IMAGE_SECTION=""
          URLS=$(echo "$ISSUE_BODY" | grep -oP '!\[.*?\]\(\K[^)]+' || true)
          if [ -n "$URLS" ]; then
            i=1
            while IFS= read -r url; do
              # Enforce HTTPS-only
              if ! echo "$url" | grep -q '^https://'; then
                echo "Skipping non-HTTPS URL: $url"
                continue
              fi

              # Enforce Discord CDN allowlist
              host="${url#https://}"
              host="${host%%/*}"
              case "$host" in
                cdn.discordapp.com|media.discordapp.net|discordapp.com) ;;
                *)
                  echo "Skipping URL not on allowlist: $url"
                  continue
                  ;;
              esac

              FILE="screenshots/screenshot-${i}.png"
              if curl --silent --show-error --fail --location \
                --max-time 30 --connect-timeout 5 \
                --max-filesize 5242880 \
                "$url" -o "$FILE"; then
                echo "Downloaded: $FILE"
                i=$((i + 1))
              else
                echo "Failed to download: $url"
                rm -f "$FILE"
              fi
            done <<< "$URLS"
            if [ "$i" -gt 1 ]; then
              IMAGE_SECTION="## Screenshots\nBug report screenshots have been downloaded to ./screenshots/. Use the Read tool to view them."
            fi
          fi
          EOF_MARKER=$(openssl rand -hex 16)
          echo "image_section<<${EOF_MARKER}" >> $GITHUB_OUTPUT
          echo -e "$IMAGE_SECTION" >> $GITHUB_OUTPUT
          echo "${EOF_MARKER}" >> $GITHUB_OUTPUT

      # --- Build prompt ---

      - name: Build prompt from template
        id: prompt
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          IMAGE_SECTION: ${{ steps.images.outputs.image_section }}
        run: |
          python3 -c "
          import os
          template = open('.github/bug-fix-prompt.md').read()
          body = os.environ['ISSUE_BODY']
          images = os.environ.get('IMAGE_SECTION', '')
          result = template.replace('\${ISSUE_BODY}', body).replace('\${IMAGE_SECTION}', images)
          print(result)
          " > /tmp/bug-fix-prompt.txt
          EOF_MARKER=$(openssl rand -hex 16)
          echo "prompt<<${EOF_MARKER}" >> $GITHUB_OUTPUT
          cat /tmp/bug-fix-prompt.txt >> $GITHUB_OUTPUT
          echo "${EOF_MARKER}" >> $GITHUB_OUTPUT

      # --- Run OpenCode ---

      - name: Run OpenCode
        id: opencode
        uses: anomalyco/opencode/github@latest
        env:
          GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
        with:
          model: google/gemini-2.5-pro
          prompt: ${{ steps.prompt.outputs.prompt }}
          use_github_token: true

      # --- Create PRs per repo ---

      - name: Create PRs for changed repos
        id: prs
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
        run: |
          PR_URLS=""
          HAS_CHANGES=false

          for SERVICE in storefront vendorpanel backend customer-backend; do
            REPO_DIR="repos/${SERVICE}"
            if [ ! -d "$REPO_DIR" ]; then continue; fi

            cd "$REPO_DIR"

            # Stage any uncommitted changes, including untracked files
            if [ -n "$(git status --porcelain)" ]; then
              git add -A
              git commit -m "fix: discord bug #${ISSUE_NUM}"
            fi

            # Check for commits ahead of origin/main
            COMMITS=$(git rev-list --count origin/main..HEAD 2>/dev/null || echo 0)
            if [ "$COMMITS" -gt 0 ]; then
              HAS_CHANGES=true
              BRANCH="fix/discord-bug-${ISSUE_NUM}"

              # Create branch (force-create handles re-runs)
              git checkout -B "$BRANCH"
              git push --force-with-lease origin "$BRANCH"

              # Check for existing PR before creating
              EXISTING_PR=$(gh pr list \
                --repo "tanvirc/sidedecked-${SERVICE}" \
                --head "$BRANCH" \
                --json url --jq '.[0].url // empty' 2>/dev/null || true)

              if [ -n "$EXISTING_PR" ]; then
                PR_URL="$EXISTING_PR"
                echo "Updated existing PR in sidedecked-${SERVICE}: ${PR_URL}"
              else
                PR_URL=$(gh pr create \
                  --repo "tanvirc/sidedecked-${SERVICE}" \
                  --title "fix: discord bug #${ISSUE_NUM}" \
                  --body "Automated fix for sidedecked-workspace-v2#${ISSUE_NUM}" \
                  --head "$BRANCH" \
                  --base main)
              fi

              PR_URLS="${PR_URLS}- ${SERVICE}: ${PR_URL}\n"
              echo "Created PR in sidedecked-${SERVICE}: ${PR_URL}"
            fi

            cd "$GITHUB_WORKSPACE"
          done

          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          EOF_MARKER=$(openssl rand -hex 16)
          echo "pr_urls<<${EOF_MARKER}" >> $GITHUB_OUTPUT
          echo -e "$PR_URLS" >> $GITHUB_OUTPUT
          echo "${EOF_MARKER}" >> $GITHUB_OUTPUT

      # --- Notifications ---

      - name: Notify success
        if: steps.prs.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_WEBHOOK_SECRET: ${{ secrets.DISCORD_WEBHOOK_SECRET }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          PR_URLS: ${{ steps.prs.outputs.pr_urls }}
        run: |
          ESCAPED_URLS=$(echo "$PR_URLS" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))" | sed 's/^"//;s/"$//')
          curl -s -X POST "${DISCORD_WEBHOOK_URL}/webhook" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Secret: ${DISCORD_WEBHOOK_SECRET}" \
            -d "{\"issue_number\": ${ISSUE_NUM}, \"status\": \"success\", \"pr_urls\": \"${ESCAPED_URLS}\"}"
          COMMENT_BODY=$(printf "Fix PRs created:\n%s" "$PR_URLS")
          gh issue comment "${ISSUE_NUM}" \
            --repo tanvirc/sidedecked-workspace-v2 \
            --body "$COMMENT_BODY"

      - name: Notify failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_WEBHOOK_SECRET: ${{ secrets.DISCORD_WEBHOOK_SECRET }}
          ISSUE_NUM: ${{ github.event.issue.number }}
        run: |
          gh issue edit "${ISSUE_NUM}" \
            --repo tanvirc/sidedecked-workspace-v2 \
            --add-label "needs-human" 2>/dev/null || true
          curl -s -X POST "${DISCORD_WEBHOOK_URL}/webhook" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Secret: ${DISCORD_WEBHOOK_SECRET}" \
            -d "{\"issue_number\": ${ISSUE_NUM}, \"status\": \"failure\", \"message\": \"Could not auto-fix. Needs developer attention.\"}" || true
          gh issue comment "${ISSUE_NUM}" \
            --repo tanvirc/sidedecked-workspace-v2 \
            --body "Auto-fix failed. Needs manual investigation." || true
