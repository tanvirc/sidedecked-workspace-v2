# TCG Catalog ETL Pipeline Seeding Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Seed and maintain a real multi-game catalog via reliable ETL so discovery features run on real data.
**Story:** story-2-1 - _bmad-output/implementation-artifacts/story-2-1-tcg-catalog-etl-pipeline-seeding.md
**Domain:** Customer Experience
**Repos:** customer-backend
**Deployment:** false (internal ETL behavior and scheduler changes only; no new external endpoint consumers)
**UX Wireframe:** N/A

## Requirements Brief (from Phase 2)
- Import and map card data for MTG, Pokemon, Yu-Gi-Oh, and One Piece into sidedecked-db with game-specific attributes.
- Preserve universal SKU shape `{GAME}-{SET}-{NUMBER}-{LANG}-{CONDITION}-{FINISH}`.
- Enforce deterministic duplicate resolution: highest completeness, then latest source `updated_at`, then smallest stable source identifier.
- Enforce token normalization for SKU components: uppercase, ASCII transliteration, non-alnum to `-`, collapse repeated `-`, trim edge `-`, fallback `UNK` for missing tokens.
- Guarantee atomicity and rollback on failures (transactional per game) with structured logging.
- Execute as initial seed plus weekly scheduled sync.

## Technical Design (from Phase 3)
- Keep all ETL persistence in customer-backend and sidedecked-db (no mercur-db access).
- Reuse existing ETL stack in `packages/tcg-catalog` and entrypoint script `src/scripts/master-etl.ts`.
- Add weekly ETL orchestration in `JobScheduler` with idempotent behavior and ETL job tracking via `ETLJob`.
- Keep API routes stable; no contract changes required for this story.
- Address game code consistency risk (`OPTCG` vs `ONEPIECE`) in ETL orchestration and tests.

---

### Task 1: Add regression tests for per-game atomic ETL and duplicate-resolution policy
**Files:**
- customer-backend/src/tests/services/ETLService.atomicity.test.ts (create)
- customer-backend/src/tests/services/ETLService.duplicates.test.ts (create)
- customer-backend/src/tests/services/ETLService.sku-normalization.test.ts (create)
**Steps:**
- TDD cycle: write failing tests for (a) transaction rollback on per-game failure, (b) deterministic duplicate winner selection, (c) SKU normalization + `UNK` fallback.
- Verify fail with targeted test run.
- Implement minimal production changes only required for failures.
- Re-run tests and commit.

### Task 2: Enforce per-game transaction boundaries and structured ETL failure logging
**Files:**
- customer-backend/packages/tcg-catalog/src/services/ETLService.ts
- customer-backend/src/scripts/master-etl.ts
- customer-backend/src/scripts/check-atomicity.ts
**Steps:**
- TDD cycle: start from failing atomicity/logging tests.
- Ensure each game run is isolated transactionally and does not corrupt existing data when a game fails.
- Standardize structured error payload fields for ETL job errors and logs.
- Re-run tests and commit.

### Task 3: Implement deterministic duplicate/conflict resolution in ETL card/print upsert flow
**Files:**
- customer-backend/packages/tcg-catalog/src/services/ETLService.ts
- customer-backend/packages/tcg-catalog/src/utils/Helpers.ts
**Steps:**
- TDD cycle: failing duplicate-resolution tests first.
- Implement completeness scoring and tie-break chain (`updated_at`, stable source id).
- Apply rule consistently before upsert write paths.
- Re-run tests and commit.

### Task 4: Implement and validate SKU normalization policy at generation and validation boundaries
**Files:**
- customer-backend/packages/tcg-catalog/src/utils/Helpers.ts
- customer-backend/packages/tcg-catalog/src/services/SKUValidationService.ts
- customer-backend/src/tests/routes/catalog-sku.test.ts
**Steps:**
- TDD cycle: add failing normalization cases including special characters, whitespace, non-ASCII, and missing components.
- Implement normalization helper and apply in SKU formatting path.
- Keep public SKU API behavior backward-compatible for existing valid SKUs.
- Re-run tests and commit.

### Task 5: Ensure all four games import with correct game-specific mappings and consistent game code handling
**Files:**
- customer-backend/packages/tcg-catalog/src/services/ETLService.ts
- customer-backend/packages/tcg-catalog/src/utils/Constants.ts
- customer-backend/src/scripts/master-etl.ts
- customer-backend/src/tests/services/ETLService.game-mapping.test.ts (create)
**Steps:**
- TDD cycle: failing tests for game-code normalization and per-game attribute mapping assertions.
- Resolve `OPTCG`/`ONEPIECE` orchestration mismatch in a single canonical mapping layer.
- Verify MTG/Pokemon/YGO/One Piece mapping paths remain distinct and complete.
- Re-run tests and commit.

### Task 6: Add weekly scheduled ETL sync job (seed remains manual/bootstrap)
**Files:**
- customer-backend/src/services/JobScheduler.ts
- customer-backend/src/index.ts
- customer-backend/src/tests/services/JobScheduler.etl.test.ts (create)
**Steps:**
- TDD cycle: add failing tests for weekly ETL scheduling and guarded execution behavior.
- Add `weekly-catalog-etl-sync` job invoking ETL service per game with idempotent semantics.
- Ensure startup/shutdown hooks manage scheduler lifecycle safely.
- Re-run tests and commit.

### Task 7: Validate end-to-end ETL behavior and quality gates
**Files:**
- customer-backend/src/scripts/master-etl.ts
- customer-backend/src/scripts/check-atomicity.ts
- customer-backend/src/tests/services/ETLService.atomicity.test.ts
- customer-backend/src/tests/services/JobScheduler.etl.test.ts
**Steps:**
- TDD cycle: add final failing integration-level assertions where needed.
- Run targeted ETL dry-run checks, then full quality gate in `customer-backend`.
- Confirm changed-area coverage >= 80% for ETL-related modules.
- Re-run tests and commit.
