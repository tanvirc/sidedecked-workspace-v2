# Story 2.2: Multi-Vendor Checkout

## Status
Draft

## Story
**As a** customer,
**I want** a unified checkout experience across vendors,
**so that** I can purchase everything at once with confidence.

## Acceptance Criteria
1. AC1: Checkout flow collects shipping, billing, and payment details with validation per step.
2. AC2: Backend creates Stripe payment intents per vendor and confirms in a single flow.
3. AC3: Confirmation page displays consolidated summary and order numbers per vendor.
4. AC4: Failure states roll back cart mutations and present actionable messaging.

## Tasks / Subtasks
- [ ] Implement multi-step checkout UI (shipping → payment → review) with step validation (AC1).
- [ ] Invoke backend Stripe customer provisioning during account creation (AC4).
- [ ] Integrate checkout API to create per-vendor payment intents and confirm collectively (AC2).
- [ ] Build confirmation page summarizing per-vendor orders, totals, and next steps (AC3).
- [ ] Handle failure scenarios: revert cart, release reservations, surface error messaging/logs (AC4).
- [ ] Add telemetry for checkout completion/failure and update analytics dashboards (AC3-AC4).
- [ ] Document checkout flow in `docs/epics/epic-02` with sequence diagrams (AC2-AC4).

## Dev Notes
- Storefront checkout pages: `storefront/src/app/(checkout)/checkout/*`.
- Backend order service under `backend/src/modules/order` should orchestrate intents and finalize orders.
- Use Stripe Payment Intents API with Connect transfers; ensure idempotency keys per checkout session.
- Stripe customer creation should occur via existing commerce service or new adapter (check `backend/src/services/stripe/`).
- Ensure cart state stored in Redis or DB to restore on failure; coordinate with inventory reservations.
- Provide accessible UI (stepper, form validation) and localization of error messages.

## Testing
- Component tests for each checkout step validation and summary totals.
- Integration tests simulating multi-vendor checkout success and failure (using Stripe test keys).
- Playwright end-to-end covering full checkout with two vendors, verifying confirmation page.
- Chaos test: inject API failure to confirm rollback + user messaging.

## Change Log
| Date       | Version | Description              | Author |
|------------|---------|--------------------------|--------|
| 2025-09-13 | 0.1.0   | Initial story draft      | Codex  |
