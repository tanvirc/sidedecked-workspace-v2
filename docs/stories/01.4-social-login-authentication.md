# Story 2.1: Social Login Authentication

## Status
Draft

## Story
**As a** returning user,
**I want** to sign in with my social provider,
**so that** I can access my account quickly and securely.

## Acceptance Criteria
1. AC1: Login modal surfaces all providers with PKCE and links to existing accounts by provider id.
2. AC2: Failed attempts emit structured error codes (`auth.provider_mismatch`, `auth.account_disabled`).
3. AC3: Successful login issues rotated access + refresh tokens; reused refresh tokens are invalidated.
4. AC4: Login capture device metadata for session management dashboard.

## Tasks / Subtasks
- [ ] Update storefront login modal to reuse provider list and PKCE flow (AC1).
- [ ] Extend backend auth callback to map provider ids to existing accounts and raise typed errors (AC1, AC2).
- [ ] Implement token rotation + reuse detection with automatic invalidation and logging (AC3).
- [ ] Persist device metadata (UA, IP, device name) and expose via session dashboard API (AC4).
- [ ] Add telemetry for login outcomes and surfaced error codes (AC2-AC3).
- [ ] Refresh documentation around session management and provider linking (AC1-AC4).

## Dev Notes
- Storefront login UI under `storefront/src/app/(auth)/user/page.tsx` and shared components in `storefront/src/components/auth`.
- Backend token logic likely in `backend/src/modules/auth/services/session-service.ts`.
- Device metadata stored in `user_sessions` table; ensure GDPR compliance for data retention.
- Provide error mapping to storefront to display localized messages.
- Consider rate limiting login attempts per IP; reuse existing middleware if available.

## Testing
- Backend unit tests for provider lookup and token rotation logic.
- Integration tests for error scenarios (disabled account, new provider) using mocks.
- Storefront component tests verifying error messaging and loading states.
- Playwright flow: login success, login with wrong provider, verify session dashboard shows device.

## Change Log
| Date       | Version | Description              | Author |
|------------|---------|--------------------------|--------|
| 2025-09-13 | 0.1.0   | Initial story draft      | Codex  |
