# Story 2.2: Session Lifecycle & MFA

## Status
Draft

## Story
**As a** security-conscious user,
**I want** resilient session management,
**so that** my account remains protected across devices.

## Acceptance Criteria
1. AC1: Refresh token rotation enforced with single valid token per device; reuse triggers session invalidation.
2. AC2: Optional TOTP MFA configurable from profile and enforced on sensitive actions.
3. AC3: Session dashboard lists active devices with ability to revoke remotely.
4. AC4: Backend enforces login rate limiting (e.g., 5 attempts / 10 min per IP/provider).

## Tasks / Subtasks
- [ ] Implement refresh token rotation with per-device tracking and reuse detection (AC1).
- [ ] Add TOTP setup flow (QR, secret) in profile settings and enforce on vendor payouts or admin actions (AC2).
- [ ] Build session dashboard UI listing devices with revoke endpoints (AC3).
- [ ] Configure rate limiting middleware and logging for excessive login attempts (AC4).
- [ ] Update security documentation and support SOPs for MFA resets (AC2-AC4).
- [ ] Add migration scripts for new tables/columns storing MFA secrets and session metadata (AC1-AC2).

## Dev Notes
- Token management under `backend/src/modules/auth/services/session-service.ts`; extend to store device_id and rotation history.
- Use industry libraries (e.g., `otplib`) for TOTP; store secrets encrypted at rest.
- Session dashboard UI likely in `storefront/src/app/(auth)/user/security`.
- Rate limiting can use existing Redis-based guard; ensure per-provider keys.
- Consider push/email notifications when new device registered or session revoked.

## Testing
- Unit tests for token rotation, reuse detection, MFA validation.
- Integration tests: login with MFA, attempt reuse of refresh token, revoke device session.
- Component tests for session dashboard and MFA setup flows.
- Security regression: attempt brute-force login to confirm rate limiting.

## Change Log
| Date       | Version | Description              | Author |
|------------|---------|--------------------------|--------|
| 2025-09-13 | 0.1.0   | Initial story draft      | Codex  |
