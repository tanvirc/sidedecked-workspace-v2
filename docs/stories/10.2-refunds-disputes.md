# Story 10.2: Refunds & Disputes

## Status
Draft

## Story
**As** support staff,
**I want** to manage refunds and disputes,
**so that** customers remain protected during payment issues.

## Acceptance Criteria
1. AC1: Admin tools initiate full or partial refunds with reason codes and audit trail.
2. AC2: Stripe dispute webhook updates order status and notifies support queue.
3. AC3: Refund statuses synced back to storefront and vendor analytics.
4. AC4: Policies enforced (time limits, restocking fees) with validations.

## Tasks / Subtasks
- [ ] Build admin refund UI/API supporting partial amounts, reasons, and audit logging (AC1).
- [ ] Implement webhook handler for Stripe disputes updating order + ticketing system (AC2).
- [ ] Sync refund/dispute state to storefront order history and vendor analytics metrics (AC3).
- [ ] Add policy engine verifying time windows and restocking fee rules before processing (AC4).
- [ ] Update documentation/runbooks for support workflows and escalations (AC1-AC4).
- [ ] Ensure notifications sent to customer and vendor on refund/dispute status changes (AC2-AC3).

## Dev Notes
- Refund API in `backend/src/modules/payments/refunds`; maintain idempotency via Stripe ids.
- Admin UI may exist in vendorpanel or separate operations dashboard; confirm location.
- Use queue to process webhook events reliably with retry/backoff.
- Policies stored in config table; provide overrides requiring supervisor approval.
- Analytics updates should feed into vendor insights (Epic 07) for accuracy.

## Testing
- Unit tests for refund calculation/policy validation.
- Integration tests simulating Stripe refund/dispute events.
- Playwright or Cypress scenario for admin initiating refund and verifying order updates.
- QA verifying audit logs and notifications generated correctly.

## Change Log
| Date       | Version | Description              | Author |
|------------|---------|--------------------------|--------|
| 2025-09-13 | 0.1.0   | Initial story draft      | Codex  |
