# Story 10.1: Payment Intent Orchestration

## Status
Draft

## Story
**As a** customer,
**I want** a seamless payment experience,
**so that** checkout feels trustworthy and accurate for multi-vendor orders.

## Acceptance Criteria
1. AC1: Backend creates payment intents per vendor with application fees and captures on confirmation.
2. AC2: Storefront handles 3DS/SCA flows via Stripe Elements with clear error handling.
3. AC3: Partial failures roll back captured charges and restore cart state.
4. AC4: Successful payment produces order and receipt records linked to Stripe IDs.

## Tasks / Subtasks
- [ ] Update backend checkout service to orchestrate per-vendor payment intents (AC1).
- [ ] Implement Stripe Elements integration handling 3DS/SCA and display user messaging (AC2).
- [ ] Add rollback logic for partial failures, releasing reservations and restoring cart (AC3).
- [ ] Persist Stripe identifiers and receipt artifacts with order records (AC4).
- [ ] Add telemetry/logging for payment flows including failure diagnostics (AC1-AC4).
- [ ] Update documentation & runbooks for payment process (AC1-AC4).

## Dev Notes
- Backend payment module: check `backend/src/modules/payments/` for existing scaffolding.
- Ensure idempotency using Stripe idempotency keys and internal transaction management.
- Rollbacks should coordinate with inventory reservation service (Story 09.2 dependency).
- Storefront should show step-by-step progress UI with localized messaging.
- Confirm compliance with PCI guidelines (no card data stored on servers).

## Testing
- Unit tests for backend payment orchestration, including failure scenarios.
- Integration tests using Stripe test keys for SCA-required flows.
- Playwright checkout flow verifying success and partial failure handling.
- Performance monitoring to ensure payment API latency stays within acceptable limits.

## Change Log
| Date       | Version | Description              | Author |
|------------|---------|--------------------------|--------|
| 2025-09-12 | 0.1.0   | Initial story draft      | Codex  |
