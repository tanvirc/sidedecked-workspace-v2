# Story 9.2: Reservation & Allocation

## Status
Draft

## Story
**As the** commerce engine,
**I want** to reserve inventory during checkout,
**so that** oversells are prevented.

## Acceptance Criteria
1. AC1: Checkout creates reservations with expiration; timers managed by queue workers.
2. AC2: Successful payment converts reservation to fulfillment entry; failure releases stock.
3. AC3: Inventory locks respected across distributed instances with transactional integrity.
4. AC4: Edge cases (partial fulfillment, vendor cancellations) handled gracefully.

## Tasks / Subtasks
- [ ] Design reservation data model storing cart line, quantity, expiry, status (AC1).
- [ ] Implement reservation creation on checkout initiation and background worker for expiration (AC1, AC2).
- [ ] Integrate payment success/failure handlers to confirm or release reservations (AC2).
- [ ] Add distributed locking or DB-level safeguards to prevent concurrent oversells (AC3).
- [ ] Handle edge cases: partial shipments, manual vendor cancellations, rollback flows (AC4).
- [ ] Update documentation/runbooks for reservation management and support overrides (AC1-AC4).

## Dev Notes
- Reservation service in `backend/src/modules/inventory/reservations`; use TypeORM transactions.
- Worker timers via BullMQ with short intervals; ensure idempotent operations.
- Integrate with checkout events from Epic 02 and payment events from Epic 10.
- Provide admin/vendor APIs to view and manually release reservations if needed.
- Audit log all reservation changes for compliance.

## Testing
- Unit tests for reservation lifecycle transitions (pending → confirmed → released).
- Integration tests simulating concurrent checkouts to validate locking.
- Playwright/E2E scenario verifying cart reservation prevents oversell and handles failure.
- Stress test to confirm worker can process expiration load.

## Change Log
| Date       | Version | Description              | Author |
|------------|---------|--------------------------|--------|
| 2025-09-13 | 0.1.0   | Initial story draft      | Codex  |
