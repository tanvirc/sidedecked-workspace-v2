# Story 1.3: Email Verification Lifecycle

## Status
Draft

## Story
**As a** user,
**I want** to verify my email address,
**so that** I can unlock secure marketplace and community capabilities.

## Acceptance Criteria
1. AC1: Registration triggers transactional email with secure token expiring in 24 hours.
2. AC2: Verification link marks email verified and removes feature restrictions.
3. AC3: Unverified users see persistent banner and disabled CTAs with tooltip messaging.
4. AC4: Resend verification rate limited and audit logged per attempt; change email triggers new verification.

## Tasks / Subtasks
- [ ] Implement backend email verification token generator with 24h expiry and single-use enforcement (AC1).
- [ ] Integrate transactional email service template and send on registration and resend flows (AC1, AC4).
- [ ] Build verification endpoint updating user status, unlocking restricted features, and logging event (AC2).
- [ ] Add storefront banner and CTA disabling logic with clear messaging and analytics (AC3).
- [ ] Implement resend and change-email flows with rate limiting and audit logs (AC4).
- [ ] Update documentation/runbooks for support team handling verification issues (AC1-AC4).

## Dev Notes
- Backend: add verification service under `backend/src/modules/auth/verification`; reuse existing email provider integration.
- Persist tokens in `verification_tokens` table with user id, expiry, consumption metadata.
- Storefront banner placement likely in `storefront/src/components/layout/GlobalAlerts`.
- Restricted features include checkout, reviews, community postsâ€”ensure gating checks email status.
- Audit logs should use existing logger/tracing utilities with correlation IDs for support tracing.

## Testing
- Unit tests for token generation, expiration, and consumption rules.
- Integration tests covering verification success, expired token, resend rate limiting.
- Component tests for banner visibility and disabled CTA tooltips.
- Playwright flow: user registers, sees banner, verifies via emailed link, banner disappears.

## Change Log
| Date       | Version | Description              | Author |
|------------|---------|--------------------------|--------|
| 2025-09-13 | 0.1.0   | Initial story draft      | Codex  |
